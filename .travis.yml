os:
- windows
language: node_js

node_js:
- 11

sudo: required

#dist: bionic

stages:
- name: build_app
  if: branch = build
- name: deploy
  if: branch IN (master, demo-sdk)
jobs:
  include:
  - stage: build_app
    #before_install:
    #  - sudo dpkg --add-architecture i386
    #  - sudo apt-get install --no-install-recommends -y gcc-multilib g++-multilib
    #  - sudo apt-get install wine32
    before_install:
    - |-
      case $TRAVIS_OS_NAME in
        windows)
          [[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64
          choco uninstall -y mingw
          choco upgrade --no-progress -y msys2
          export msys2='cmd //C RefreshEnv.cmd '
          export msys2+='& set MSYS=winsymlinks:nativestrict '
          export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
          export mingw64="$msys2 -mingw64 -full-path -here -c \$\* --"
          export msys2+=" -msys2 -c \$\* --"
          $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-toolchain
          ## Install more MSYS2 packages from https://packages.msys2.org/base here
          taskkill //IM gpg-agent.exe //F  # https://travis-ci.community/t/4967
          export PATH=/C/tools/msys64/mingw64/bin:$PATH
          export MAKE=mingw32-make  # so that Autotools can find it
          ;;
      esac
    before_cache:
    - |-
        case $TRAVIS_OS_NAME in
          windows)
            # https://unix.stackexchange.com/a/137322/107554
            $msys2 pacman --sync --clean --noconfirm
            ;;
        esac
    cache:
      directories:
      - $HOME/AppData/Local/Temp/chocolatey
      - /C/tools/msys64
    install: true
    script:
    - make publish
    #after_success:
    #- bash <(curl -s https://codecov.io/bash)
  - stage: deploy
    services: docker
    install: true
    script:
    - docker run -it -e JENKINS_AUTH_TOKEN=$JENKINS_AUTH_TOKEN -e JENKINS_BUILD_TOKEN=$JENKINS_BUILD_TOKEN
      -e JENKINS_BUILD_PROJECT=$TRAVIS_REPO_SLUG -e JENKINS_BUILD_BRANCH=$TRAVIS_BRANCH
      p1hub/p1jenkinstrigger
notifications:
  email: false
  slack:
    secure: bQy4pPIsKlcmG9OzT/SJeSBKtebrkNcg7zk5mkSo7CoxyzH+G1rq8gYwFM2papOY9FpSMuDToQW9wfJur8wXtomaTbpgOTfjQkMDEFTsWPx/QRZAP9FKDt9/wBWZvwMi+CmEv8ksj4c90c7TDwFIAe+SC0LCLsz/iQ9UTxh7Q1nleCwwKteuT5lTJOz7ov/IoFnM7m7yPjKHlSHal1By/aZYD0Jtd244L1TuomNB2Ccj1QeBzlSUI+fpCe3UL9uRV/OE1fUNGi4g+ZnwBVd3zxv8kwPcdYCJbUzYqEVDFNJOzscJgkU5cx4/qleSo0PYQbPVjo6byEMC9wR+Rcxv/H1zASKWk8HAYKb6bq7nufOP0kI5hxt6tEu5Rbusz7RQXr3/QIbT+bMcIKp2ARbGoClzVkO4n3/8it/cum4fVB6nrqjEpJANwo6buaW0W2jVbXxcAiYESBxpQasSCr/z2+U0Hxga2+cwolP0Dl3xyOfGpQrZcB/5whhhsiW2gGnVPhzvGfhG6K176qeliHQ0iN+8kL1NkbJiw9wRpuPC+AVc1IoFBhRUTfH7bCXUPfu7WVXrROPtIFdg6ASLt1wiiIZvggBUM+HkW643aPXbdEhCjLH7F5nnd0IfQM2Mymdc+hTf/ZlgJQ3qZxEL3ynjzWkUZ7yyVELP7IaxH5luCkQ=
